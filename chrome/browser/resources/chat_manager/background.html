<!DOCTYPE html>
<html>
<!--

Copyright (c) 2010 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.

Extension purpose: route all Google Talk chats through the central roster
hosted in this extension. The included logic is paired with logic in Gmail
to route both incoming and outgoing chats through this central roster.

-->
<body>
<style>
  .talk_roster {
    position: fixed;
    left: 0px;
    top: 0px;
  }
  .talk_iframe {
    width: 100%;
    height: 100%;
    border: none;
    overflow-x: hidden;
    overflow-y: hidden;
  }
</style>
<script>
  var args = {
    'host': 'talkgadget.google.com',
    'jsmode': 'pre',
    'hl': 'en',
  };
  // Read args.
  var urlParts = window.location.href.split(/[?&#]/);
  for (var i = 1; i < urlParts.length; i++) {
    var argParts = urlParts[i].split('=');
    if (argParts.length == 2) {
      args[argParts[0]] = argParts[1];
    }
  }
  document.write('<script src="https://' + args['host'] +
      '/talkgadget/notifier-js?silent=true&host=https://' + args['host'] +
      '/talkgadget/notifier-js' +
      (args['jsmode'] != '' ? ('&jsmode=' + args['jsmode']) : '') +
      '"></scr' + 'ipt>');
</script>
<script src="js/chatbridgeeventtypes.js"></script>
<script>
  var chatClient = null;
  if (window.GTalkNotifier) {
    chatClient = new GTalkNotifier(
        'http://' + args['host'] + '/talkgadget/',
        'notifierclient' +
            (args['jsmode'] != '' ? ('?jsmode=' + args['jsmode']) : ''),
        'ifpc_relay',
        'ifpc.js',
        'Google Talk',
        {
          hostCallback: function(){},
          xpcRelay: 'xpc_relay',
          xpcBlank: 'xpc_blank',
          locale: args['hl'],
          isCentralRoster: true,
          hideProfileCard: true
        }
    );
  } else {
    document.write(
        '<div class="talk_roster"><b>GTalkNotifier undefined</b></div>');
  }
  var centralRosterJid;
  var tabIdToGmPort = {};

  // Notify all open Gmail pages of updated central roster jid.
  function forwardCentralRosterJidToGmPorts() {
    for (var tabId in tabIdToGmPort) {
      var port = tabIdToGmPort[tabId];
      if (port != null) {
        port.postMessage({jid: centralRosterJid});
      }
    }
  }

  // Observe all tab closures. Clear the corresponding Gmail tracking entry.
  chrome.tabs.onRemoved.addListener(function(tabId) {
    if (tabIdToGmPort[tabId] != null) {
      delete tabIdToGmPort[tabId];
    }
  });

  // Listen for content script connections with Gmail pages and add a
  // corresponding tracking entry.
  chrome.extension.onConnect.addListener(function(port) {
    if (port.name == 'centralJidWatcher') {
      tabIdToGmPort[port.sender.tab.id] = port;
    }
  });

  // Listen for requests from our content scripts.
  chrome.extension.onRequest.addListener(function(request, sender) {
    switch (request.msg) {
      // For new initiated chats, forward to this page's GTalk client.
      case ChatBridgeEventTypes.SHOW_CHAT:
        if (chatClient != null) {
          chatClient._showChat(request.jid);
        }
        break;
      case ChatBridgeEventTypes.START_VIDEO:
        if (chatClient != null) {
          chatClient._startVideoChat(request.jid);
        }
        break;
      case ChatBridgeEventTypes.START_VOICE:
        if (chatClient != null) {
          chatClient._startVoiceChat(request.jid);
        }
        break;
      // For changes in the central roster, forward to all Gmail pages.
      case ChatBridgeEventTypes.CENTRAL_USER_UPDATE:
        if (centralRosterJid != request.jid) {
          centralRosterJid = request.jid;
          forwardCentralRosterJidToGmPorts();
        }
        break;
      // For a request of the latest central roster jid, respond back to the
      // requesting port.
      case ChatBridgeEventTypes.REQUEST_CENTRAL_USER:
        var tabId = sender.tab.id;
        var port = tabIdToGmPort[tabId];
        if (port != null) {
          port.postMessage({jid: centralRosterJid});
        }
        break;
    }
  });
</script>
</body>
</html>
