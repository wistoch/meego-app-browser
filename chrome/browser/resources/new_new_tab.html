<!DOCTYPE html>
<html i18n-values="
  dir:textdirection;
  bookmarkbarattached:bookmarkbarattached;
  hasattribution:hasattribution;
  anim:anim;
  syncispresent:syncispresent;
  haspromo:haspromo">

<meta charset="utf-8">
<title i18n-content="title"></title>
<script>
// Logging info for benchmarking purposes.
var log = [];
function logEvent(name, shouldLogTime) {
  if (shouldLogTime) {
    chrome.send('logEventTime', [name]);
  }
  log.push([name, Date.now()]);
}
logEvent('Tab.NewTabScriptStart', true);

var global = this;

/**
 * Registers a callback function so that if the backend calls it too early it
 * will get delayed until DOMContentLoaded is fired.
 * @param {string} name The name of the global function that the backend calls.
 */
function registerCallback(name) {
  var f = function(var_args) {
    var args = Array.prototype.slice.call(arguments);
    // If we still have the temporary function we delay until the dom is ready.
    if (global[name] == f) {
      logEvent(name + ' is not yet ready. Waiting for DOMContentLoaded');
      document.addEventListener('DOMContentLoaded', function() {
        logEvent('Calling the new ' + name);
        global[name].apply(null, args);
      });
    }
  };
  global[name] = f;
}

chrome.send('getMostVisited');
chrome.send('getRecentlyClosedTabs');
chrome.send('getTips');
chrome.send('getApps');

registerCallback('onShownSections');
registerCallback('mostVisitedPages');
registerCallback('recentlyClosedTabs');
registerCallback('syncMessageChanged');
registerCallback('tips');
registerCallback('onHomePageSet');
registerCallback('getAppsCallback');

</script>
<!-- template data placeholder -->
<link rel="stylesheet" href="new_new_tab.css">
<script>

/**
 * Bitmask for the different UI sections.
 * This matches the Section enum in ../dom_ui/shown_sections_handler.h
 * @enum {number}
 */
var Section = {
  THUMB: 1,
  // LIST is no longer used
  RECENT: 4,
  TIPS: 8,
  SYNC: 16,
  DEBUG: 32
};

var shownSections = templateData['shown_sections'];

function $(id) {
  return document.getElementById(id);
}

// Until themes can clear the cache, force-reload the theme stylesheet.
document.write('<link id="themecss" rel="stylesheet" ' +
               'href="chrome://theme/css/newtab.css?' +
               (new Date()).getTime() + '">');

function useSmallGrid() {
  return window.innerWidth <= 920;
}

function isRtl() {
  return templateData['textdirection'] == 'rtl';
}

// Keep track of the last small state so we can ensure that we are using the
// right mode. This is a workaround for http://crbug.com/25329
var wasSmallGrid;

function getMostVisitedLayoutRects() {
  var small = useSmallGrid();
  wasSmallGrid = small;

  var cols = 4;
  var rows = 2;
  var marginWidth = 10;
  var marginHeight = 7;
  var borderWidth = 4;
  var thumbWidth = small ? 150 : 207;
  var thumbHeight = small ? 93 : 129;
  var w = thumbWidth + 2 * borderWidth + 2 * marginWidth;
  var h = thumbHeight + 40 + 2 * marginHeight;
  var sumWidth = cols * w  - 2 * marginWidth;

  var rtl = isRtl();
  var rects = [];

  if (shownSections & Section.THUMB) {
    for (var i = 0; i < rows * cols; i++) {
      var row = Math.floor(i / cols);
      var col = i % cols;
      var left = rtl ? sumWidth - col * w - thumbWidth - 2 * borderWidth :
          col * w;

      var top = row * h;

      rects[i] = {left: left, top: top};
    }
  }
  return rects;
}

function applyMostVisitedRects() {
  if (shownSections & Section.THUMB) {
    var rects = getMostVisitedLayoutRects();
    var children = $('most-visited').children;
    for (var i = 0; i < 8; i++) {
      var t = children[i];
      t.style.left = rects[i].left + 'px';
      t.style.top = rects[i].top + 'px';
      t.style.right = '';
      var innerStyle = t.firstElementChild.style;
      innerStyle.left = innerStyle.top = '';
    }
  }
}

// TODO(arv): Remove these when classList is available in HTML5.
// https://bugs.webkit.org/show_bug.cgi?id=20709
function hasClass(el, name) {
  return el.nodeType == 1 && el.className.split(/\s+/).indexOf(name) != -1;
}

function addClass(el, name) {
  var names = el.className.split(/\s+/);
  if (names.indexOf(name) == -1) {
    el.className += ' ' + name;
  }
}

function removeClass(el, name) {
  var names = el.className.split(/\s+/);
  el.className = names.filter(function(n) {
    return name != n;
  }).join(' ');
}

function updateSimpleSection(id, section) {
  if (shownSections & section)
    removeClass($(id), 'hidden');
  else
    addClass($(id), 'hidden');
}

</script>
</head>
<body class="loading"
      i18n-values=".style.fontFamily:fontfamily;.style.fontSize:fontsize">

<div id="container">
<div id="main">

  <div id=top-bar>
    <div id="tip-line"></div>
    <script>updateSimpleSection('tip-line', Section.TIPS)</script>
    <input type="button" id="option-button"
        i18n-values="title:pagedisplaytooltip">
  </div>

  <div id="option-menu" class="window-menu">
    <div command="hide" section="TIPS" i18n-content="tips"></div>
    <div command="hide" section="THUMB" i18n-content="mostvisited"></div>
    <div command="hide" section="RECENT" i18n-content="recentlyclosed"></div>
    <hr>
    <div command="clear-all-blacklisted"
         i18n-content="restorethumbnails"></div>
  </div>

  <div id="notification">
    <span>&nbsp;</span>
    <span class="link"><span class="link-color"></span></span>
  </div>

  <div class="section disabled" id="apps-section"></div>

  <div id="most-visited-section" class="section" section="THUMB">
    <h2 i18n-content="mostvisited"></h2>

    <div id="most-visited">
      <a class="thumbnail-container filler" tabindex="1" id="t0">
        <div class="edit-mode-border">
          <div class="edit-bar">
            <div class="pin"></div>
            <div class="spacer"></div>
            <div class="remove"></div>
          </div>
          <span class="thumbnail-wrapper">
            <span class="thumbnail"></span>
          </span>
        </div>
        <div class="title">
          <div></div>
        </div>
      </a>
    </div>
  </div>

  <div id="recently-closed" class="section" section="RECENT">
    <h2 i18n-content="recentlyclosed"></h2>
    <span>
      <span class="nav">
        <a href="chrome://history/" class="item"
            i18n-content="viewfullhistory"></a>
      </span>
    </span>
  </div>

  <div id="debug" class="section disabled" section="DEBUG">
    <h2>Debug</h2>
    <div id="apps-launch-control">
      Open apps in:<label
      ><input type="radio" name="launch-container-type" value=""
          checked="true">Default</label
      ><label><input type="radio" name="launch-container-type" value="tab"
          >Tab</label
      ><label><input type="radio" name="launch-container-type" value="window"
          >Window</label
      ><label><input type="radio" name="launch-container-type" value="panel"
          >Panel</label>
    </div>
  </div>

  <script>
    (function() {
      updateSimpleSection('recently-closed', Section.RECENT);
      updateSimpleSection('most-visited-section', Section.THUMB);
      updateSimpleSection('debug', Section.DEBUG);
      var el = $('most-visited');
      for (var i = 1; i < 8; i++) {
        el.appendChild(el.firstElementChild.cloneNode(true)).id = 't' + i;
      }

      applyMostVisitedRects();
    })();
  </script>

  <div id="sync-status">
    <h2></h2>
    <span></span>
  </div>

  <div id="attribution" class="attribution">
    <div i18n-content="attributionintro"></div>
    <img id="attribution-img">
  </div>

</div> <!-- main -->

<div id="footer">
  <div id="promo-line">
    <span id="promo-new" i18n-content="promonew"></span>
    <span id="promo-message" i18n-values=".innerHTML:promomessage"></span>
    <button class="link" id="promo-close"></button>
  </div>
  <div id="bottom-right-promo">
    <a i18n-values="href:extensionslink">
      <img id="promo-image" src="chrome://theme/newtab_extensions_promo">
    </a>
  </div>
</div>

</div>  <!-- container -->

<div class="window-menu" id="window-tooltip"></div>

</body>
<script src="i18n_template.js"></script>
<script src="local_strings.js"></script>
<script src="new_new_tab.js"></script>
</html>
