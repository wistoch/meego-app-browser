<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script>
var onbeforeunloadInvoked= false;
var onunloadInvoked = false;
var popupDismissed = false;
var toolbarView = chrome.extension.getToolstrips()[0];

// Onload handler that tests the popup dismissal behaviour when closing the
// current tab.  A popup is launched and the timing of the onClosed callback
// is tested wrt the onbeforeunload and onunload callbacks.
window.onload = function() {
  chrome.experimental.popup.onClosed.addListener(function() {
    toolbarView.assertTrue(onbeforeunloadInvoked,
                           "Popup dismissed before onbeforeunload called.");
    toolbarView.assertTrue(!onunloadInvoked,
                           "Popup dismissed after onunload called.");
    popupDismissed = true;
  });

  var showDetails = {
    "relativeTo": document.getElementById("popupAnchor")
  };
  chrome.experimental.popup.show("toolband_popup.html",
                                 showDetails,
                                 function() {
    chrome.tabs.getSelected(null, function(tab) {
      chrome.tabs.remove(tab.id);
    });
  });
}

window.onbeforeunload = function() {
  onbeforeunloadInvoked = true;
}

window.onunload = function() {
  onunloadInvoked = true;

  // If the popup was not yet dismissed, do not signal that the test has
  // completed.  Let the test time-out to signal failure.
  if (popupDismissed)
    toolbarView.testCompleted();
};
</script>
</head>
<body>
Testing Popup Sizing
<div id='popupAnchor'>
<span>Anchor Temporary Popup Here</span>
</div>
</body>
</html>
