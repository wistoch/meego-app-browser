<script>
window.onload = function() {
  chrome.extension.onConnect.addListener(function(port) {
    console.log('onConnect');
    port.onMessage.addListener(function(msg) {
      console.log('got message');
      if (msg.testPostMessageFromTab) {
        port.postMessage({success: true, portName: port.name});
        console.log('sent success');
      }
      // Ignore other messages since they are from us.
    });
  });
  chrome.extension.onConnectExternal.addListener(function(port) {
    port.onMessage.addListener(function(msg) {
      if (msg.testConnectExternal) {
        port.postMessage({success: true, senderId: port.sender.id});
      }
    });
  });
};

// Tests that postMessage to the tab and its response works.
function testPostMessage() {
  chrome.tabs.getSelected(null, function(tab) {
    var port = chrome.tabs.connect(tab.id);
    console.log('connect to ' + tab.id);
    port.postMessage({testPostMessage: true});
    port.onMessage.addListener(function(msg) {
      window.domAutomationController.send(msg.success);
      port.disconnect();
    });
  });
}

// Tests that port name is sent & received correctly.
function testPortName() {
  chrome.tabs.getSelected(null, function(tab) {
    var portName = "lemonjello";
    var port = chrome.tabs.connect(tab.id, {name: portName});
    console.log('naming port ' + portName);
    port.postMessage({testPortName: true});
    port.onMessage.addListener(function(msg) {
      console.log('got name ' + msg.portName);
      window.domAutomationController.send(msg.portName == portName);
      port.disconnect();
    });
  });
}

// Tests that postMessage from the tab and its response works.
function testPostMessageFromTab() {
  chrome.tabs.getSelected(null, function(tab) {
    var port = chrome.tabs.connect(tab.id);
    console.log('connect to ' + tab.id);
    port.postMessage({testPostMessageFromTab: true});
    port.onMessage.addListener(function(msg) {
      window.domAutomationController.send(msg.success);
      port.disconnect();
    });
  });
}

// Tests that we get the disconnect event when the tab disconnect.
function testDisconnect() {
  chrome.tabs.getSelected(null, function(tab) {
    var port = chrome.tabs.connect(tab.id);
    console.log('connect to ' + tab.id);
    port.postMessage({testDisconnect: true});
    port.onDisconnect.addListener(function() {
      window.domAutomationController.send(true);
    });
  });
}

// Tests that we get the disconnect event when the tab context closes.
function testDisconnectOnClose() {
  chrome.tabs.getSelected(null, function(tab) {
    var port = chrome.tabs.connect(tab.id);
    console.log('connect to ' + tab.id);
    port.postMessage({testDisconnectOnClose: true});
    port.onDisconnect.addListener(function() {
      window.domAutomationController.send(true);
    });
  });
}
</script>
