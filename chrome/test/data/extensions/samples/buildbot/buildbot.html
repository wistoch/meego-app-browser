<script>
var botRoot = "http://build.chromium.org/buildbot/waterfall";
//var botRoot = "http://chrome-buildbot.corp.google.com:8010";
var statusURL = "http://chromium-status.appspot.com/current";
var waterfallURL = botRoot + "/bot_status.json?json=1";
var botList;
var checkinResults;
var bots;
var lastChecked;

function updateStatus(text) {
  // Page outputs a line like this:
  // <div class="Notice">Tree is open (issue -> person) </div> 
  // Although what's in the <div> is arbitrary and typed by a person.
  var results = (new RegExp('"Notice"[^>]*>(.*)<', 'g')).exec(text);
  if (!results || results.index < 0) {
    throw new Error("couldn't find status div in " + text);
  }
  var status = results[1];
  var div = document.getElementById("status");
  div.title = status;
  var open = /open/i;
  if (open.exec(status)) {
    div.innerHTML = "tree: &nbsp;open&nbsp;";
    div.className = "open";
  } else {
    div.innerHTML = "tree: closed";
    div.className = "closed";
  }
}

function updateBotList(text) {
  var results = (new RegExp('(.*)<\/body>', 'g')).exec(text);
  if (!results || results.index < 0) {
    console.log("Error: couldn't find bot JSON");
    console.log(text);
    return;
  }
  var data;
  try {
    data = JSON.parse(results[1]);
  } catch (e) {
    console.dir(e);
    console.log(text);
    return;
  }
  if (!data) {
    throw new Error("JSON parse fail: " + results[1]);
  }
  botList = data[0];
  checkinResults = data[1];
  displayBotList();
}

function botClicked(botIndex) {
  var bot = botList[botIndex];
  var url = botRoot + "/waterfall?builder=" + bot.name;
  window.open(url);
  window.event.stopPropagation();
}

function displayBotList() {
  if (!botList) {
    console.log("botList is null");
    return;
  }
  var html = "";
  if (bots.className == "visible") {
    botList.forEach(function(bot, i) {
      html += "<div class='bot " + bot.color +
          "' onclick='botClicked(" + i + ")' " +
          "title='" + bot.title + "'></div>";
    });
  }
  bots.innerHTML = html;

  var numBots = botList.length;
  var botWidth = numBots * 8 + 2;
  var style = document.getElementById("bots-visible");
  style.innerText = "#bots.visible { width:" + botWidth + "px;}";
}

function requestStatus() {
  requestURL(statusURL, updateStatus);
  setTimeout(requestStatus, 120000);
}

function requestURL(url, callback) {
  console.log("requestURL: " + url);
  var xhr = new XMLHttpRequest();
  try {
    xhr.onreadystatechange = function(state) {
      if (xhr.readyState == 4) {
        var text = xhr.responseText;
        //console.log(text);
        callback(text);
      }
    }

    xhr.onerror = function(error) {
      console.log("xhr error: " + JSON.stringify(error));
      console.dir(error);
    }

    xhr.open("GET", url, true);
    xhr.send({});
  } catch(e) {
    console.log("exception: " + e);
  }
}

function showBots() {
  var now = new Date();
  // Don't ever refetch the bot list more frequently than every 60 seconds.
  if (!lastChecked || (now - lastChecked) > 60000) {
    lastChecked = now;
    requestURL(waterfallURL, updateBotList);
  }
  hoverTimerId = null;
  bots.className = "visible";
}

function hideBots() {
  bots.className = "";
}

var hoverTimerId = null;

window.addEventListener("mouseover", function(e) {
  if (hoverTimerId) {
    hoverTimerId = window.clearTimeout(hoverTimerId);
  } else if (bots.className != "visible") {
    hoverTimerId = window.setTimeout(function() {
      hoverTimerId = null;
      showBots();
    }, 500);
  }
}, false);

window.addEventListener("mouseout", function(e) {
  if (hoverTimerId) {
    hoverTimerId = window.clearTimeout(hoverTimerId);
  } else if (bots.className != "") {
    hoverTimerId = window.setTimeout(function() {
      hoverTimerId = null;
      hideBots();
    }, 100);
  }
}, false);

window.addEventListener("click", function() {
  window.open(botRoot);
}, false);

window.onload = function() {
  // This is weird, but somehow doing an XHR -- even though it is
  // asynchronous!! -- in onload delays the initial render from happening.
  window.setTimeout(requestStatus, 10);
  bots = document.getElementById("bots");
}
</script>

<style id="bots-visible">
#bots.visible {
  width:1px;
}
</style>

<style>
#status {
  font-weight:bold;
}

#change {
  font-weight:bold;
}

.open {
  color: green;
}

.closed {
  color: red;
}

#bots {
  height: 100%;
  /* We would rather this be zero, but a rendering bug in WebKit causes the
     offset width of the document to sometimes be caluculated incorrectly that
     way. */
  width: 1px;
  -webkit-transition: width .2s linear;
  display:-webkit-box;
  -webkit-box-align:center; /* center content vertically */
  overflow: hidden;
}

.bot {
  line-height: 100%;
  cursor: pointer;
  -webkit-border-radius: 2px;
  display:-webkit-box;
  width: 6px;
  height: 15px;
}

.bot:first-child {
  /* Since #bots is 1px wide, this is necessary so that we don't show the first
     pixel of the first bot. */
  margin-left:1px;
}

.running {
  background-color:  rgb(255, 252, 108);
  border: 1px solid rgb(197, 197, 109);
}

.notstarted {
  /* background-color: white; */
  border: 1px solid rgb(170, 170, 170);
}

.failure {
  background-color: rgb(233, 128, 128);
  border: 1px solid rgb(167, 114, 114);
}

.warnings {
  background-color: rgb(255, 195, 67);
  border: 1px solid rgb(194, 157, 70);
}

.success {
  background-color: rgb(143, 223, 95);
  border: 1px solid rgb(79, 133, 48);
}

.exception {
  background-color: rgb(224, 176, 255);
  border: 1px solid rgb(172, 160, 179);
}

</style>

<div class="toolstrip-button">
  <span id="status" class="open">
    <span style="color:#ff6600">loading...</span>
  </span>
</div>
<div id="bots">
</div>
