<script>

var botRoot = "http://build.chromium.org/buildbot/waterfall";

var botUrl = botRoot + "/horizontal_one_box_per_builder";

function updateStatus(status) {
  var div = document.getElementById("status");
  div.title = status;
  var open = /open/i;
  if (open.exec(status)) {
    div.innerHTML = "tree: &nbsp;open&nbsp;";
    div.className = "open";
  } else {
    div.innerHTML = "tree: closed";
    div.className = "closed";
  }
}

function requestStatus() {
  var bots = document.getElementById("bots");
  if (bots) {
    // TODO(erikkay): this generates "Unsafe JavaScript attempt to access frame
    // with URL"
    bots.src = botUrl + "?xxx=" + (new Date()).getTime();
  }
  var xhr = new XMLHttpRequest();
  try {
    xhr.onreadystatechange = function(state) {
      if (xhr.readyState == 4) {
        var text = xhr.responseText;
        var re = /"Notice"[^>]*>([^<\n]+)</g;
        var results = re.exec(text);
        if (results && results.index >= 0) {
          updateStatus(results[1]);
        } else {
          console.log("Error: couldn't find node");
        }
      }
    }
    
    xhr.onerror = function(error) {
      console.log("xhr error: " + error);
    }

    xhr.open("GET", "http://chromium-status.appspot.com/current");
    xhr.send({});
  } catch(e) {
    console.log("exception: " + e);
  }
  setTimeout(requestStatus, 30000);
}

function statusClick() {
  window.open(botRoot);
}

requestStatus();
</script>
<style>
.open {
  color: green;
}

.closed {
  color: red;
}

#bots {
  border: none;
  height: 20px;  /* hardcoded height sucks */
  width: 435px;  /* hardcoded width sucks */
  background-color: transparent;
  display:-webkit-box;
}

#frame-wrapper {
  /* This is used to get us to vertically center the iframe in the vertical
  space. */
  display:-webkit-box;
  -webkit-box-align:center;
  /* Also, scooch the frame in a bit, under the button, because the content of
  the frame has some extra built-in left padding. */
  margin-left:-10px;
}

</style>

<div class="toolstrip-button" onclick="statusClick();">
<span id="status" class="open">tree: open?</span>
</div>

<div id="frame-wrapper">
<iframe scrolling='no' id='bots' src="http://build.chromium.org/buildbot/waterfall/horizontal_one_box_per_builder"></iframe>
</div>
