<script>
var botRoot = "http://build.chromium.org/buildbot/waterfall";
var botUrl = botRoot + "/horizontal_one_box_per_builder";

function updateStatus(status) {
  var div = document.getElementById("status");
  div.title = status;
  var open = /open/i;
  if (open.exec(status)) {
    div.innerHTML = "tree: &nbsp;open&nbsp;";
    div.className = "open";
  } else {
    div.innerHTML = "tree: closed";
    div.className = "closed";
  }
}

function requestStatus() {
  var xhr = new XMLHttpRequest();
  try {
    xhr.onreadystatechange = function(state) {
      if (xhr.readyState == 4) {
        var text = xhr.responseText;
        var re = /"Notice"[^>]*>([^<\n]+)</g;
        var results = re.exec(text);
        if (results && results.index >= 0) {
          updateStatus(results[1]);
        } else {
          console.log("Error: couldn't find node");
        }
      }
    }
    
    xhr.onerror = function(error) {
      console.log("xhr error: " + error);
    }

    xhr.open("GET", "http://chromium-status.appspot.com/current");
    xhr.send({});
  } catch(e) {
    console.log("exception: " + e);
  }
  setTimeout(requestStatus, 30000);
}

var hoverTimerId = null;
var hideTimerId = null;

window.addEventListener("mouseover", function(e) {
  if (hideTimerId) {
    hideTimerId = window.clearTimeout(hideTimerId);
  }

  if (bots.className != "visible" && !hoverTimerId) {
    hoverTimerId = window.setTimeout(function() {
      hoverTimerId = null;
      var bots = document.getElementById("bots");
      bots.className = "visible";
      // TODO(erikkay): this generates "Unsafe JavaScript attempt to access
      // frame with URL".
      bots.src = botUrl + "?xxx=" + (new Date()).getTime();
    }, 1000);
  }
}, false);

window.addEventListener("mouseout", function(e) {
  if (hoverTimerId) {
    hoverTimerId = window.clearTimeout(hoverTimerId);
  }

  if (bots.className != "" && !hideTimerId) {
    hideTimerId = window.setTimeout(function() {
      hideTimerId = null;
      var bots = document.getElementById("bots");
      bots.className = "";
    }, 1000);
  }
}, false);

window.addEventListener("click", function() {
  window.open(botRoot);
}, false);

requestStatus();
</script>

<style>
#status {
  font-weight:bold;
}

.open {
  color: green;
}

.closed {
  color: red;
}

#bots {
  border: none;
  height: 15px;
  width: 0;
  -webkit-transition: width .2s linear;
  background-color: transparent;
  display:-webkit-box;
  margin-left:-5px;
}

#bots.visible {
  width: 435px;  /* hardcoded width sucks */
}

#frame-wrapper {
  /* This is used to get us to vertically center the iframe in the vertical
  space. */
  -webkit-box-align:center;
  /* Also, scooch the frame in a bit, under the button, because the content of
  the frame has some extra built-in left padding. */
  display:-webkit-box;
}

</style>

<div class="toolstrip-button">
<span id="status" class="open">tree: open?</span>
<div id="frame-wrapper">
<iframe scrolling="no" id="bots"></iframe>
</div>
</div>
