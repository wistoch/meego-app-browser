<script>
var botRoot = "http://build.chromium.org/buildbot/waterfall";
//var botRoot = "http://chrome-buildbot.corp.google.com:8010";
var waterfallURL = botRoot + "/bot_status.json?json=1";
var botList;
var checkinResults;
var bots;
var failures;

function updateBotList(text) {
  var results = (new RegExp('(.*)<\/body>', 'g')).exec(text);
  if (!results || results.index < 0) {
    console.log("Error: couldn't find bot JSON");
    console.log(text);
    return;
  }
  var data;
  try {
    data = JSON.parse(results[1]);
  } catch (e) {
    console.dir(e);
    console.log(text);
    return;
  }
  if (!data) {
    throw new Error("JSON parse fail: " + results[1]);
  }
  botList = data[0];
  checkinResults = data[1];

  failures = botList.filter(function(bot) {
    return (bot.color != "success");
  });
  displayFailures();
}

function displayFailures() {
  var html = "";
  if (failures.length == 0) {
    html = "<a href='" + botroot +
        "' class='open'>The tree is completely green.</a> (no way!)";
  } else {
    html = "<div class='closed'>Failures:</div>";
    failures.forEach(function(bot, i) {
      html += "<div class='bot " + bot.color +
          "' onclick='botClicked(" + i + ")'>" +
          bot.title + "</div>";
    });
  }
  bots.innerHTML = html;
}

function botClicked(botIndex) {
  var bot = failures[botIndex];
  var url = botRoot + "/waterfall?builder=" + bot.name;
  window.open(url);
  window.event.stopPropagation();
}

function requestURL(url, callback) {
  console.log("requestURL: " + url);
  var xhr = new XMLHttpRequest();
  try {
    xhr.onreadystatechange = function(state) {
      if (xhr.readyState == 4) {
        var text = xhr.responseText;
        //console.log(text);
        callback(text);
      }
    }

    xhr.onerror = function(error) {
      console.log("xhr error: " + JSON.stringify(error));
      console.dir(error);
    }

    xhr.open("GET", url, true);
    xhr.send({});
  } catch(e) {
    console.log("exception: " + e);
  }
}
window.onload = function() {
  bots = document.getElementById("bots");
  bots.innerHTML = "onload";
  //window.setTimeout(requestUrl(waterfallURL, updateBotList), 10);
  requestURL(waterfallURL, updateBotList);
}
</script>
<style>
body {
  font: menu;
  width: 200px;
  background-color: #dddddd;
  overflow: hidden;
}

.bot {
  cursor: pointer;
  -webkit-border-radius: 5px;
  margin-top: 1px;
  padding: 3px;
}

.bot:hover {
  border: 2px solid black;
  padding: 2px;
}

.open {
  color: green;
}

.closed {
  color: red;
}

.running {
  background-color:  rgb(255, 252, 108);
  border: 1px solid rgb(197, 197, 109);
}

.notstarted {
  border: 1px solid rgb(170, 170, 170);
}

.failure {
  background-color: rgb(233, 128, 128);
  border: 1px solid rgb(167, 114, 114);
}

.warnings {
  background-color: rgb(255, 195, 67);
  border: 1px solid rgb(194, 157, 70);
}

.success {
  background-color: rgb(143, 223, 95);
  border: 1px solid rgb(79, 133, 48);
}

.exception {
  background-color: rgb(224, 176, 255);
  border: 1px solid rgb(172, 160, 179);
}
</style>
<div id="bots">Loading....</div>
