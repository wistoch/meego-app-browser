<html>
<head>
<link rel="stylesheet" type="text/css" href="styles.css">
<script>
gmail_atom_href = "http://mail.google.com/mail/feed/atom";
var poll_timeout = 1000 * 60;  // 1 minute
var unreadCount;
var debug = true;

function gmailNSResolver(prefix) {
  if(prefix == 'gmail') {
    return 'http://purl.org/atom/ns#';
  }
}

function startFlip() {
  document.getElementById("notLoggedIn").style.display = "none";
  document.getElementById("loggedIn").style.display = "";
  document.getElementById("unreadCount").className = 'mid-flip';
  setTimeout("midFlip();", 500);
}

function midFlip() {
  document.getElementById("unreadCount").className = 'post-flip';  
  document.getElementById("unreadCount").innerHTML = "(" + unreadCount + ")";
  setTimeout("endFlip();", 500);
}

function endFlip() {
  document.getElementById("unreadCount").className = 'base-flip';  
}

function updateUnreadCount(count) {
  if (unreadCount != count) {
    unreadCount = count;
    startFlip();
  }
}

function requestUnreadFeed() {  
  var xhr = new XMLHttpRequest();
  try {
    console.log("request..");
    xhr.onreadystatechange = function(){
      console.log("readystate: " + xhr.readyState);
      if (xhr.readyState == 4) {
        if (xhr.responseXML) {
          window.clearTimeout(timerId);

          console.log("response..");
          var xmlDoc = xhr.responseXML;
          var fullCountSet = xmlDoc.evaluate("/gmail:feed/gmail:fullcount", 
              xmlDoc, gmailNSResolver, XPathResult.ANY_TYPE, null);
          var fullCountNode = fullCountSet.iterateNext();
          if (fullCountNode) {
            updateUnreadCount(fullCountNode.textContent);
          } else {
            console.log("fullcount not found!");
            console.error("Error: feed retrieved, but no <fullcount> node found");
          }
        }

        window.setTimeout(requestUnreadFeed, poll_timeout);
      }
    }
    
    xhr.onerror = function(error) {
  	  console.log("error: " + error);
      window.setTimeout(requestUnreadFeed, poll_timeout);
    }

    xhr.open("GET", gmail_atom_href, true);
    xhr.send(null);

    // Give up after 5 seconds
    var timerId = window.setTimeout(function() {
      document.getElementById("loggedIn").style.display = "none";
      document.getElementById("notLoggedIn").style.display = "";
      xhr.abort();
    }, 5000);
  } catch(e) {
    console.log("ex: " + e);
    console.error("exception: " + e);
    window.setTimeout(requestUnreadFeed, poll_timeout);
  }
}

function goToInbox() {
  chromium.tabs.create({url:"http://www.gmail.com/"});
}

</script>
</head>
<body onload="window.setTimeout(requestUnreadFeed, 0)" onclick="goToInbox()">
  <div class="toolstrip-button">
    <img src="gmail.png" style="width:auto; height:auto">
    <span id="notLoggedIn" style="display:none;">Login</span>
    <span id="loggedIn">Gmail - Inbox <span style="display: inline-block;" id="unreadCount" class="base-flip" onclick="startFlip();"></span></span>
  </div>
</body>
</html>
