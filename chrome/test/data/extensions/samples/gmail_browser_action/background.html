<html>
<head>
<script>
var animationFrames = 36;
var animationSpeed = 10; // ms
var browserActionWidth = 27;
var browserActionHeight = 23;
var canvasContext;
var gmail = "http://mail.google.com/";
var gmailAtomRef = "http://mail.google.com/mail/feed/atom";
var loggedInImage;
var loggedOutImage;
var pollInterval = 1000 * 10;  // 10 seconds
var requestTimeout = 1000 * 2;  // 5 seconds
var rotation = 0;
var unreadCount = 0;


chrome.tabs.onUpdated.addListener(function(tabId, changeInfo) {
  if (changeInfo.url && changeInfo.url.indexOf(gmail) == 0) {
    console.log("saw gmail! updating...");
    getInboxCount(function(count) {
      updateUnreadCount(count);
    });
  }
});

function init() {
  var canvas = document.getElementById('canvas');
  loggedInImage = document.getElementById('logged_in');
  loggedOutImage = document.getElementById('logged_out');
  canvasContext = canvas.getContext('2d');
  startRequest();
}

function scheduleRequest() {
  window.setTimeout(startRequest, pollInterval);
}

// ajax stuff
function startRequest() {
  getInboxCount(
    function(count) {
      updateUnreadCount(count);
      scheduleRequest();
    },
    function() {
      showLoggedOut();
      scheduleRequest();
    }
  );
}

function getInboxCount(onSuccess, onError) {
  var xhr = new XMLHttpRequest();
  var abortTimerId = window.setTimeout(function() {
    xhr.abort();
    onError();
  }, requestTimeout);

  function handleSuccess(count) {
    window.clearTimeout(abortTimerId);
    if (onSuccess)
      onSuccess(count);
  }

  function handleError() {
    window.clearTimeout(abortTimerId);
    if (onError)
      onError();
  }

  try {
    console.log("request..");
    xhr.onreadystatechange = function(){
      console.log("readystate: " + xhr.readyState);
      if (xhr.readyState == 4) {
        console.log("responseText: " + xhr.responseText.substring(0, 200) +
                    "...");
        if (xhr.responseXML) {
          var xmlDoc = xhr.responseXML;
          var fullCountSet = xmlDoc.evaluate("/gmail:feed/gmail:fullcount",
              xmlDoc, gmailNSResolver, XPathResult.ANY_TYPE, null);
          var fullCountNode = fullCountSet.iterateNext();
          if (fullCountNode) {
            handleSuccess(fullCountNode.textContent);
          } else {
            console.log("fullcount not found!");
            console.error("Error: feed retrieved, but no <fullcount> node " +
                          "found");
            handleError();
          }
        } else {
          console.log("No responseXML!");
        }
      }
    }

    xhr.onerror = function(error) {
      console.log("error");
      console.log(error);
      handleError();
    }

    xhr.open("GET", gmailAtomRef, true);
    xhr.send(null);
  } catch(e) {
    console.log("ex: " + e);
    console.error("exception: " + e);
    handleError();
  }
}

function gmailNSResolver(prefix) {
  if(prefix == 'gmail') {
    return 'http://purl.org/atom/ns#';
  }
}

function updateUnreadCount(count) {
  if (unreadCount != count) {
    unreadCount = count;
    animateFlip();
  }
}


function ease(x) {
  return (1-Math.sin(Math.PI/2+x*Math.PI))/2;
}

function animateFlip() {
  rotation += 1/animationFrames;
  drawIconAtRotation();
  
  if (rotation <= 1) {
    setTimeout("animateFlip()", animationSpeed);
  } else {
    rotation = 0;
    drawIconAtRotation();
    chrome.browserAction.setBadgeText({text:unreadCount});
    chrome.browserAction.setBadgeBackgroundColor({color:[255, 208, 0, 24]});
    chrome.browserAction.setTitle({title:unreadCount + " unread emails"});
  }
}

function showLoggedOut() {
  canvasContext.save();
  canvasContext.clearRect(0, 0, browserActionWidth, browserActionHeight);
  canvasContext.translate(browserActionWidth/2, browserActionHeight/2);
  canvasContext.drawImage(loggedOutImage, 
      -loggedOutImage.width/2 - 1, -loggedOutImage.height/2);
  canvasContext.restore();

  chrome.browserAction.setIcon({imageData:canvasContext.getImageData(0, 0,
      browserActionWidth,browserActionHeight)});
  chrome.browserAction.setBadgeBackgroundColor({color:[230, 190, 190, 190]});
  chrome.browserAction.setBadgeText({text:"?"});
}

function drawIconAtRotation() {
  canvasContext.save();
  canvasContext.clearRect(0, 0, browserActionWidth, browserActionHeight);
  canvasContext.translate(browserActionWidth/2, browserActionHeight/2);
  canvasContext.rotate(2*Math.PI*ease(rotation));
  canvasContext.drawImage(loggedInImage, 
      -loggedInImage.width/2 - 1, -loggedInImage.height/2);
  canvasContext.restore();

  chrome.browserAction.setIcon({imageData:canvasContext.getImageData(0, 0,
      browserActionWidth,browserActionHeight)});
}

function goToInbox() {
  chrome.tabs.create({url: gmail});
}

// Called when the user clicks on the browser action.
chrome.browserAction.onClicked.addListener(function(tab) {
  goToInbox();
});

</script>
</head>
<body onload="init()">
<img id="logged_in" src="gmail_logged_in.png">
<img id="logged_out" src="gmail_not_logged_in.png">
<canvas id="canvas" width="27" height="23">
</body>
</html>

