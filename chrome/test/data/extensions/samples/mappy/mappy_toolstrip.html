<style>
#map {
  display: none;
  width: 512px;
  height: 512px;
}
</style>
<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAATfHumDbW3OmRByfquHd3SRTRERdeAiwZ9EeJWta3L_JZVS0bOBRQeZgr4K0xyVKzUdnnuFl8X9PX0w&sensor=false"
        type="text/javascript"></script>
<script>
var maps_key = "ABQIAAAATfHumDbW3OmRByfquHd3SRTRERdeAiwZ9EeJWta3L_JZVS0bOBRQeZgr4K0xyVKzUdnnuFl8X9PX0w";

chrome.toolstrip.onCollapsed.addListener(function() {
  var map = document.getElementById("map");
  map.src = "";
  map.style.display = "none";
  var button = document.getElementById("button");
  button.style.display = "block";
});

function expand(url) {
  var button = document.getElementById("button");
  button.style.display = "none";
  var map = document.getElementById("map");
  map.src = url;
  map.style.display = "block";
  chrome.toolstrip.expand({height:512}, function() {});
}

function collapse() {
  chrome.toolstrip.collapse({}, function() {});
}

function gclient_geocode(address) {
  var geocoder = new GClientGeocoder();
  geocoder.getLatLng(address, function(point) {
    if (!point) {
      console.log(address + " not found");
    } else {
      var latlng = point.toUrlValue();
      var url = "http://maps.google.com/staticmap?center=" + latlng +
                "&markers=" + latlng + "&zoom=14" +
                "&size=512x512&sensor=false&key=" + maps_key;
      expand(url);
    }
  });
}

function map() {
  chrome.tabs.getSelected(null, function(tab) {
    var port = chrome.tabs.connect(tab.id);
    if (!port) {
      console.log("no port");
    } else {
      port.onMessage.addListener(function(data) {
        var address = data.values[0];
        gclient_geocode(address);
      });
      port.postMessage({message: "hello tab: " + tab.id});
    }
  });
};
</script>
<div id="button" class="toolstrip-button" onclick="map()">
<span>Mappy</span>
</div>
<img id="map" onclick="collapse()">
