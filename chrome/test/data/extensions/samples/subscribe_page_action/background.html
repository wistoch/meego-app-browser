<html>
<head>
<script>
  // The Page Action ID.
  var pageActionId = "RssPageAction";

  // The icon to use. This corresponds to the icon listed in the manifest.
  var subscribeId = 0;

  // A dictionary keyed off of tabId that keeps track of data per tab (for
  // example what feedUrl was detected in the tab).
  var feedData = {};

  chrome.self.onConnect.addListener(function(port) {
    // This will get called from the content script using PostMessage.
    // |feedUrls| is a list of URL feeds found on the page. We only need 1 to
    // enable the PageAction icon in the Omnibox.
    port.onMessage.addListener(function(feedUrls) {
      feedUrl = feedUrls[0];
      // Let Chrome know that the PageAction needs to be enabled for this tabId
      // and for the url of this page.
      if (feedUrl) {
        feedData[port.tab.id] = {pageUrl: port.tab.url,
                                 feedUrl: feedUrl};

        chrome.pageActions.enableForTab(
            pageActionId, {tabId: port.tab.id,
                           url: port.tab.url,
                           title: "Click to subscribe...",
                           iconId: subscribeId});
      }
    });
  });

  // Chrome will call into us when the user clicks on the icon in the OmniBox.
  chrome.pageActions["RssPageAction"].addListener(function(pageActionId,
      pageActionInfo) {
    chrome.windows.getCurrent(function(window) {
      chrome.tabs.get(pageActionInfo.tabId, function(tab) {
        // We need to know if we are the active window, because the tab may
        // have moved to another window and we don't want to execute this
        // action multiple times.
        if (window.focused) {
          // Create a new tab showing the subscription page with the right
          // feed URL.
          chrome.tabs.create({url: "subscribe.html?" +
                                       feedData[pageActionInfo.tabId].feedUrl,
                             windowId: window.windowId});
        }
      });
    });
  });

  chrome.tabs.onRemoved.addListener(function(reply) {
    feedData[reply.tabId] = null;
  });
</script>
</head>
</html>
