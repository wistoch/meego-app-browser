<html>
<head>
<title>Subscribe to feed</title>

<script type="text/javascript">
  // Grab the querystring, removing question mark at the front and splitting on
  // the ampersand.
  var queryString = location.search.substring(1).split("&");

  // The feed URL is the first component and always present.
  var feedUrl = decodeURIComponent(queryString[0]);

  // We allow synchronous requests for testing. This component is only present
  // if true.
  var synchronousRequest = queryString[1] == "synchronous";

  // The XMLHttpRequest object that tries to load and parse the feed.
  var req;
  var reqStylesheet;

  // What to show when we cannot parse the feed name.
  var unknownName = "Unknown feed name";

  // The maximum number of feed items to show in the preview.
  var maxFeedItems = 10;

  // The maximum number of characters to show in the feed item title.
  var maxTitleCount = 64;

  // The style sheet we use for both the subscribe page and the IFRAME.
  var style_sheet = "";  // Populated later using a XMLHttpRequest.

  // Navigates to the reader of the user's choice (for subscribing to the feed).
  function navigate() {
    var select = document.getElementById('readers');
    var url = select.options[select.selectedIndex].value + feedUrl;
    document.location = url;
  }

  function loadStylesheet() {
    reqStylesheet = new XMLHttpRequest();
    reqStylesheet.onload = handleCssLoaded;
    reqStylesheet.onerror = loadFeed;  // I ain't got no style, lets do without.
    reqStylesheet.open("GET", "style.css", true);
    reqStylesheet.send(null);
  }

  function handleCssLoaded() {
    style_sheet = reqStylesheet.responseText;
    loadFeed();
  }

  // Parses the feed specified. We will either end up in handleResponse or
  // handleError from here.
  function loadFeed() {
    feedUrl = decodeURIComponent(feedUrl);
    req = new XMLHttpRequest();
    req.onload = handleResponse;
    req.onerror = handleError;
    req.open("GET", feedUrl, !synchronousRequest);
    req.send(null);
  }

  // Sets the title for the feed.
  function setFeedTitle(title) {
    var titleTag = document.getElementById('title');
    titleTag.textContent = "Feed for '" + title + "'";
  }

  // Handles errors during the XMLHttpRequest.
  function handleError() {
    handleFeedParsingFailed("Error fetching feed");
  }

  // Handles feed parsing errors.
  function handleFeedParsingFailed(error) {
    setFeedTitle(unknownName);

    // The tests always expect an IFRAME, so add an one showing the error.
    var html = "<html><body><span id=\"error\" class=\"item_desc\">" + error +
               "</span></html>";

    embedAsIframe(html);
  }

  function embedAsIframe(html) {
    var itemsTag = document.getElementById('items');
    html = html.replace(/"/g, "%22");

    iframe = document.createElement('iframe');
    iframe.src = "data:text/html;charset=utf-8," + html;
    iframe.id = "rss";
    iframe.height = "100%";
    iframe.width = "100%";
    iframe.scrolling = "auto";
    iframe.frameBorder = "0";
    iframe.marginWidth = "0";
    iframe.noResize = "noresize";
    itemsTag.appendChild(iframe);
  }

  // Handles parsing the feed data we got back from XMLHttpRequest.
  function handleResponse() {
    var itemsTag = document.getElementById('items');

    // Uncomment these two lines to see what the feed data looks like.
    // itemsTag.textContent = req.responseText;
    // return;

    var doc = req.responseXML;
    if (!doc) {
      handleFeedParsingFailed("Not a valid feed");
      return;
    }

    // Figure out what the title of the whole feed is.
    var title = doc.getElementsByTagName('title')[0];
    if (title)
      setFeedTitle(title.textContent);
    else
      setFeedTitle(unknownName);

    // Obtain the base url so that we can show images using relative path.
    var base_url = "";
    var slash = feedUrl.lastIndexOf("/");
    if (slash > -1)
      base_url = feedUrl.substring(0, slash + 1);
    else
      base_url = feedUrl;
    base_url = "<base href=\"" + base_url + "\" />";

    // Start building the part we render inside an IFRAME. We use a table to
    // ensure that items are separated vertically from each other.
    var items_html = "<html><head>" + base_url +
                     "<style>" + style_sheet + "</style>" + "</head>" +
                     "<body><table>";

    // Now parse the rest. Some use <entry> for each feed item, others use
    // <channel><item>.
    var entries = doc.getElementsByTagName('entry');
    if (entries.length == 0)
      entries = doc.getElementsByTagName('item');

    for (i = 0; i < entries.length && i < maxFeedItems; ++i) {
      item = entries.item(i);

      // Grab the title for the feed item.
      var itemTitle = item.getElementsByTagName('title')[0];
      if (itemTitle)
        itemTitle = itemTitle.textContent;
      else
        itemTitle = "Unknown title";

      // Ensure max length for title.
      if (itemTitle.length > maxTitleCount)
        itemTitle = itemTitle.substring(0, maxTitleCount) + "...";

      // Grab the description.
      var itemDesc = item.getElementsByTagName('description')[0];
      if (!itemDesc)
        itemDesc = item.getElementsByTagName('summary')[0];
      if (!itemDesc)
        itemDesc = item.getElementsByTagName('content')[0];

      if (itemDesc)
        itemDesc = itemDesc.textContent;
      else
        itemDesc = "";

      // Grab the link URL.
      var itemLink = item.getElementsByTagName('link');
      var link = itemLink[0].childNodes[0];
      if (link)
        link = itemLink[0].childNodes[0].nodeValue;
      else
        link = itemLink[0].getAttribute('href');

      items_html = items_html +
          "<tr><td>" +
          "<a id=\"anchor_" + String(i) + "\" href=\"" + link + "\" " +
          "class=\"item_title\">" +
          itemTitle + "</a><br>";

      items_html = items_html + "<span class=\"item_desc\" " +
                                "id=\"desc_" + String(i) + "\">" +
                                itemDesc + "<br><br>" +
                                "</td></tr>";
    }
    items_html = items_html + "</table></body></html>";

    // Add an IFRAME with the html contents.
    embedAsIframe(items_html);
  }
</script>
  <link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body onload="loadStylesheet();">
  <table>
  <tr>
    <td width="75">
      <img src="feed-icon-64x64.png" alt="feed-icon" align="absmiddle" />
    </td>
    <td>
      <b><span id="title"></span></b><br>
      <span>Subscribe to this feed using:</span>
      <select id="readers">
        <option value="http://www.google.com/reader/view/feed/">
          Google Reader
        </option>
        <option value="http://www.google.com/ig/adde?moduleurl=">
          iGoogle
        </option>
        <option value="http://www.bloglines.com/login?r=/sub/">
          Bloglines
        </option>
        <option value="http://add.my.yahoo.com/rss?url=">
          My Yahoo
        </option>
      </select>
      <button onclick="navigate();">Subscribe Now</button>
    </td>
  </tr>
  </table>

  <div>&nbsp;</div>
  <div class="splitter"><b>Feed preview</b></div><br>
  <div id="items"></div>
</body>
</html>
