<html>
<head>
<script>
  // Called when the user clicks on the browser action.
  var clicks = 0;
  var text = "";
  chrome.browserAction.onClicked.addListener(function() {
    chrome.browserAction.setIcon({iconIndex:clicks});
    text += clicks.toString();
    chrome.browserAction.setBadgeText({text:text});
    clicks++;
    // We only have 1 icon, but cycle through 3 icons to test the
    // out-of-bounds index bug.
    if (clicks > 2)
      clicks = 0;
  });
  var i = 0;

  window.setInterval(function() {
    // Don't animate while in "click" mode.
    if (clicks > 0) return;
    i++;
    chrome.browserAction.setIcon({imageData:draw(i*2, i*4)});
  }, 50);

  function draw(starty, startx) {
    var canvas = document.getElementById('canvas');
    var context = canvas.getContext('2d');
    context.clearRect(0, 0, canvas.width, canvas.height);
    context.fillStyle = "rgba(0,200,0,255)";
    context.fillRect(startx % 20, starty % 20, 8, 8);
    context.fillStyle = "rgba(0,0,200,255)";
    context.fillRect((startx + 5) % 20, (starty + 5) % 20, 8, 8);
    context.fillStyle = "rgba(200,0,0,255)";
    context.fillRect((startx + 10) % 20, (starty + 10) % 20, 8, 8);
    return context.getImageData(0, 0, 20, 20);
  }
</script>
</head>
<body>
<canvas id="canvas" width="20" height="20"></canvas>
</body>
</html>

