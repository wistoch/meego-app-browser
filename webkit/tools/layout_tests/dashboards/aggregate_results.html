<!DOCTYPE HTML>
<html>

<head>
  <title>Layout test passing status</title>
  <style>
    h2 {
      margin: 0;
    }
    h3 {
      margin-bottom: 0;
    }
    .container {
      border: 2px solid;
      margin: 3px 0;
    }
  </style>
  <script src="dashboard_base.js"></script>
  <script>
  /**
   * @fileoverview Creates a dashboard for tracking number of passes/failures
   * per run.
   *
   * Currently, only webkit tests are supported, but adding other test types
   * should just require the following steps:
   *   -generate results.json for these tests
   *   -copy them to the appropriate location
   *   -add the builder name to the list of builders in dashboard_base.js.
   */

  //////////////////////////////////////////////////////////////////////////////
  // Methods and objects from dashboard_base.js to override.
  //////////////////////////////////////////////////////////////////////////////
  function generatePage() {
    var html = '';
    for (var builder in builders) {
      html += getHTMLForBuilder(builder);
    }
    document.body.innerHTML = html;
  }


  function getHTMLForBuilder(builder) {
    var results = resultsByBuilder[builder];
    // Some keys were added later than others, so they don't have as many
    // builds. Use the shortest.
    // TODO(ojan): Once 500 runs have finished, we can get rid of passing this
    // around and just assume all keys have the same number of builders for a
    // given builder.
    var numColumns = results[ALL_FIXABLE_COUNT_KEY].length;
    return '<div class=container><h2>' + builder + '</h2>' +
        getHTMLForSummaryTable(results, numColumns) +
        getHTMLForTestType(results, FIXABLE_COUNTS_KEY, FIXABLE_DESCRIPTION,
            numColumns) +
        getHTMLForTestType(results, DEFERRED_COUNTS_KEY, DEFERRED_DESCRIPTION,
            numColumns) +
        getHTMLForTestType(results, WONTFIX_COUNTS_KEY, WONTFIX_DESCRIPTION,
            numColumns) + '</div>';
  }

  function getHTMLForRevisionRows(results, numColumns) {
    return getHTMLForTableRow('WebKit Revision',
            results[WEBKIT_REVISIONS_KEY].slice(0, numColumns)) +
        getHTMLForTableRow('Chrome Revision',
            results[CHROME_REVISIONS_KEY].slice(0, numColumns));
  }

  function wrapHTMLInTable(description, html) {
    return '<h3>' + description + '</h3><table><tbody>' + html +
        '</tbody></table>';
  }

  function getHTMLForSummaryTable(results, numColumns) {
    var percent = [];
    var fixable = results[FIXABLE_COUNT_KEY].slice(0, numColumns);
    var allFixable = results[ALL_FIXABLE_COUNT_KEY].slice(0, numColumns);
    for (var i = 0; i < numColumns; i++) {
      var percentage = 100 * (allFixable[i] - fixable[i]) / allFixable[i];
      // Round to the nearest tenth of a percent.
      percent.push(Math.round(percentage * 10) / 10 + '%');
    }
    var html = getHTMLForRevisionRows(results, numColumns) +
        getHTMLForTableRow('Percent passed', percent) +
        getHTMLForTableRow('Failures (deduped)', fixable) +
        getHTMLForTableRow('Fixable Tests', allFixable);
    return wrapHTMLInTable('Summary', html);
  }

  function getHTMLForTestType(results, key, description, numColumns) {
    // TODO(dglazkov): Make these pretty canvasy graphs.
    var counts = results[key];
    var html = getHTMLForRevisionRows(results, numColumns);

    var valuesForEachRow = {};
    for (var i = 0; i < numColumns; i++) {
      for (var expectation in EXPECTATIONS_MAP) {
        if (expectation in counts[i]) {
          var count = counts[i][expectation];

          if (!valuesForEachRow[expectation])
            valuesForEachRow[expectation] = [];

          valuesForEachRow[expectation].push(count);
        }
      }
    }

    for (var expectation in valuesForEachRow) {
      html += getHTMLForTableRow(EXPECTATIONS_MAP[expectation],
          valuesForEachRow[expectation]);
    }

    return wrapHTMLInTable(description, html);
  }

  function getHTMLForTableRow(columnName, values) {
    return '<tr><td>' + columnName + '</td><td>' + values.join('</td><td>') +
        '</td></tr>';
  }

  </script>
  </head>
  <body></body>
</html>